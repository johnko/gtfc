#!/bin/sh

# gtfc add

gitcluster_add() {
  MYUSER1="urep"
  PEERPORT1="22"
  TOSPLIT=$1
  repo=$3
  if grep '@' ${TOSPLIT} >/dev/null 2>&1 ; then
    if [ "x" != "x${TOSPLIT%@*}" ]; then
      MYUSER1="${TOSPLIT%@*}"
    fi
  fi
  HOSTANDPORT1="${TOSPLIT#*@}"
  if [ "x" != "x${HOSTANDPORT1%:*}" ]; then
    HOST1="${HOSTANDPORT1%:*}"
  fi
  if grep ':' ${HOSTANDPORT1} >/dev/null 2>&1 ; then
    if [ "x" != "${HOSTANDPORT1#*:}" ]; then
      PEERPORT1="${HOSTANDPORT1#*:}"
    fi
  fi
  MYUSER2="urep"
  PEERPORT2="22"
  TOSPLIT=$2
  if grep '@' ${TOSPLIT} >/dev/null 2>&1 ; then
    if [ "x" != "x${TOSPLIT%@*}" ]; then
      MYUSER2="${TOSPLIT%@*}"
    fi
  fi
  HOSTANDPORT2="${TOSPLIT#*@}"
  if [ "x" != "x${HOSTANDPORT2%:*}" ]; then
    HOST2="${HOSTANDPORT2%:*}"
  fi
  if grep ':' ${HOSTANDPORT2} >/dev/null 2>&1 ; then
    if [ "x" != "${HOSTANDPORT2#*:}" ]; then
      PEERPORT2="${HOSTANDPORT2#*:}"
    fi
  fi
  if [ "x" = "x$HOST1" ]; then
    echo "ERROR: missing host1" >&2
    exit 1
  elif [ "x" = "x$HOST2" ]; then
    echo "ERROR: missing host2" >&2
    exit 1
  elif [ "x" = "x$repo" ]; then
    repo="~/gitsync"
  fi
  ssh -t -A -p $PEERPORT2 $MYUSER2@$HOST2 "gtfc clone $1 $repo"
  ssh -t    -p $PEERPORT1 $MYUSER1@$HOST1 "sh $repo/.gtfc/gitpullall.sh -f"
}

gitcluster_add $1 $2 $3
