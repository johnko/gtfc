#!/bin/sh

# should be called from a kqueue watcher or manually
# $0 /path/to/watch

export FOLDER=$1
. ${HOME}/bin/gtfc-parsefolder

[ -d ${FOLDER} ] || exit 1

cd ${FOLDER}

git add --all .
git commit -a -m "modified - `whoami`@`hostname`"

for i in ${NODES} ; do
    export TOSPLIT=$i
    . ${HOME}/bin/gtfc-parse
    install -d -m 700 "/var/tmp/${USER}"
    if [ "x" != "x${HOST}" ]; then
        LOCK_FILE="/tmp/${MYUSER}/${HOST}-${SAFEFOLDERNAME}.lock"
        # Attempt to lock the lock file if it is set. via https://gist.github.com/liquidgecka/9788122
        if [ -n "$LOCK_FILE" ] ; then
            exec 200>> "$LOCK_FILE"
            flock -w 0 -x 200
            if [ $? -ne 0 ] ; then
                echo "Unable to obtain a lock, is a job already running?"
                exit 1
            fi
        fi
        git push ssh://${MYUSER}@${HOST}:${PEERPORT}/${REMOTEFOLDER} master tomerge &
    fi
done
