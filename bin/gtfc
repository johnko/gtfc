#!/bin/sh
######################################################################
# LICENSE pulled in with, cat LICENSE | awk '{print "# "$0}'
######################################################################
# Copyright (c) 2015, John Ko
# All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions are met:
#
# * Redistributions of source code must retain the above copyright notice, this
#   list of conditions and the following disclaimer.
#
# * Redistributions in binary form must reproduce the above copyright notice,
#   this list of conditions and the following disclaimer in the documentation
#   and/or other materials provided with the distribution.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
# AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
# DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
# FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
# SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
# CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
# OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
# OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#
######################################################################
# Script version is yymmdd-HHMMSS in UTC, date +%y%m%d-%H%M%S
######################################################################
SCRIPTVERSION=150112-071917

########## if root has ~/.ssh/authorized_keys, install it to urep user
# install -d -o urep -g urep /usr/home/urep/.ssh
# install -o urep -g urep ~/.ssh/authorized_keys /usr/home/urep/.ssh/

######################################################################
# ssh-keygen id_rsa
######################################################################
cd ${HOME}

[ -f ${HOME}/.ssh/id_rsa ] \
  || ssh-keygen -N '' -t rsa -b 4096 -f ${HOME}/.ssh/id_rsa
[ -f ${HOME}/.ssh/authorized_keys2 ] \
  || cp ${HOME}/.ssh/id_rsa.pub ${HOME}/.ssh/authorized_keys2

######################################################################
# 1. on HOSTA as urep, run: gtfc init
######################################################################
if [ "init" = "$1" ]; then

  [ -d gitsync ] || git init gitsync
  [ -d gitsync ] || exit 1

  cd gitsync
  git config user.email "urep@localhost"
  git config user.name "urep"
  git remote add ${2} urep@${2}:~/gitsync
  cp ~/.ssh/authorized_keys2 authorized_keys2
  cp .git/config config
  cat >crontab.pullall <<EOF
* * * * * sh /usr/home/urep/gitsync/gitpullall.sh
EOF
  cat >gitpullall.sh <<EOF
#!/bin/sh
pgrep -lf gitpullall.sh && exit 1
cd /usr/home/urep/gitsync
setupauthkeys2() {
  diff config .git/config || cp config .git/config
  diff \
    authorized_keys2 \
    /usr/home/urep/.ssh/authorized_keys2 \
    || cat \
      authorized_keys2 \
      /usr/home/urep/.ssh/id_rsa.pub | sort -u > /usr/home/urep/.tmp
  cp /usr/home/urep/.tmp /usr/home/urep/.ssh/authorized_keys2
}
setupauthkeys2
for i in \$(/usr/local/bin/git remote); do
  if echo \$i | grep push >/dev/null 2>&1 ; then
    /usr/local/bin/git push -q \$i master
  else
    /usr/local/bin/git pull -q \$i master
  fi
done
setupauthkeys2
crontab crontab.pullall
EOF
  cat >crontab.pullbare <<EOF
* * * * * sh /usr/home/urep/gitsync/gitpullbare.sh
EOF
  cat >gitpullbare.sh <<EOF
#!/bin/sh
pgrep -lf gitpullbare.sh && exit 1
cd /usr/home/urep/gitsync
setupauthkeys2() {
  diff \
    authorized_keys2 \
    /usr/home/urep/.ssh/authorized_keys2 \
    || cat \
      authorized_keys2 \
      /usr/home/urep/.ssh/id_rsa.pub | sort -u > /usr/home/urep/.tmp
  cp /usr/home/urep/.tmp /usr/home/urep/.ssh/authorized_keys2
}
setupauthkeys2
/usr/local/bin/git pull
setupauthkeys2
crontab crontab.pullbare
EOF

  git add .
  git commit -m first
  # end of init

######################################################################
# 2. on HOSTA as urep, run: gtfc add hostB
######################################################################
elif [ "add" = "$1" ]; then # run this on HOSTA before running on clones
  [ -d gitsync ] || exit 1
  cd gitsync
  git remote add ${2} urep@${2}:~/gitsync
  while diff .git/config config ; do
    sleep 1
  done
  cp .git/config config
  git add .
  git commit -m "added $2 to config"
  # end of add

######################################################################
# 3. on hostB as urep, run: gtfc clone HOSTA
######################################################################
elif [ "clone" = "$1" ]; then # run on clones
  [ -d gitsync ] || git clone urep@${2}:~/gitsync
  [ -d gitsync ] || exit 1
  cd gitsync
  sh gitpullall.sh
  cp /usr/home/urep/.ssh/authorized_keys2 authorized_keys2
  git add .
  git commit -m "added `hostname` to authorized_keys2"
######################################################################
# 4. on HOSTA as urep, run: sh gitsync/gitpullall.sh
######################################################################
  ssh urep@${2} 'sh ~/gitsync/gitpullall.sh'

######################################################################
# 5. on HOSTA as urep, run: gtfc push hostB
######################################################################
elif [ "push" = "$1" ]; then
  [ -d gitsync ] || exit 1
  cd gitsync
  git remote add push${2} urep@${2}:~/gitsyncpush
  ssh urep@${2} 'git init --bare gitsyncpush'
  while diff .git/config config ; do
    sleep 1
  done
  cp .git/config config
  git add .
  git commit -m "added push$2 to config"
  git push push${2} master
  ssh urep@${2} 'git clone gitsyncpush gitsync'
  # end of push

fi
