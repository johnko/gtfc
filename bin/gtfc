#!/bin/sh

MYUSER="urep"
MYHOSTNAME="`hostname`"
PEERPORT="22"

######################################################################
# ssh-keygen id_rsa
######################################################################
cd ${HOME}

[ -f ${HOME}/.ssh/id_ed25519 ] \
  || ssh-keygen -N '' -t ed25519 -f $HOME/.ssh/id_ed25519
[ -f ${HOME}/.ssh/authorized_keys2 ] \
  || cat >${HOME}/.ssh/authorized_keys2 <<EOF
command="gtfc-shell -c \"\$SSH_ORIGINAL_COMMAND\" `cat ${HOME}/.ssh/id_ed25519.pub`"
EOF

######################################################################
# 1. on HOSTA as ${MYUSER}, run: gtfc init HOSTA folder
######################################################################
TOSPLIT=$2
if grep '@' ${TOSPLIT} >/dev/null 2>&1 ; then
  if [ "x" != "x${TOSPLIT%@*}" ]; then
    MYUSER="${TOSPLIT%@*}"
  fi
fi
HOSTANDPORT="${TOSPLIT#*@}"
if [ "x" != "x${HOSTANDPORT}" ]; then
  HOST="${HOSTANDPORT%:*}"
fi
if grep ':' ${HOSTANDPORT} >/dev/null 2>&1 ; then
  if [ "x" != "${HOSTANDPORT#*:}" ]; then
    PEERPORT="${HOSTANDPORT#*:}"
  fi
fi
if [ "x" = "x$HOST" ]; then
  HOST="`hostname -s`"
fi

FOLDER=$3
if [ "x" = "x$FOLDER" ]; then
  FOLDER="${HOME}/gitsync"
fi

if [ "init" = "$1" ]; then

  [ -d ${FOLDER} ] || git init ${FOLDER}
  [ -d ${FOLDER} ] || exit 1

  cd ${FOLDER}
  mkdir .gtfc
  git config user.email "${MYUSER}@localhost"
  git config user.name "${MYUSER}"
  git remote add ${HOST} ssh://${MYUSER}@${HOST}:${PEERPORT}/${FOLDER}
  cp ${HOME}/.ssh/authorized_keys2 .gtfc/authorized_keys2
  cp .git/config .gtfc/config
  cat >.gtfc/crontab.pullall <<EOF
* * * * * sh ${FOLDER}/.gtfc/gitpullall.sh
EOF
  cat >.gtfc/gitpullall.sh <<EOF
#!/bin/sh
if [ "\$1" != "-f" ]; then
  pgrep -lf gitpullall.sh >/dev/null 2>&1 && exit 1
fi
cd ${FOLDER}
setupauthkeys2() {
       GTFCCONFIG=.gtfc/config
  [            -e .gtfc/config.\$(hostname) ] \
    && GTFCCONFIG=.gtfc/config.\$(hostname)
  diff \$GTFCCONFIG .git/config || cp \$GTFCCONFIG .git/config

       GTFCAUTHKEYS=.gtfc/authorized_keys2
  [              -e .gtfc/authorized_keys2.\$(hostname) ] \
    && GTFCAUTHKEYS=.gtfc/authorized_keys2.\$(hostname)
  if ! diff \$GTFCAUTHKEYS \${HOME}/.ssh/authorized_keys2 ; then
    echo "command=\"git-shell -c \\\\\"\\\$SSH_ORIGINAL_COMMAND\\\\\"\" \`cat \${HOME}/.ssh/id_rsa.pub\`" >\${HOME}/.tmpa
    cat     \$GTFCAUTHKEYS \${HOME}/.tmpa | sort -u >\${HOME}/.ssh/authorized_keys2
  fi

       GTFCKNOWNHOSTS=.gtfc/known_hosts
  [                -e .gtfc/known_hosts.\$(hostname) ] \
    && GTFCKNOWNHOSTS=.gtfc/known_hosts.\$(hostname)
  if ! diff \$GTFCKNOWNHOSTS \${HOME}/.ssh/known_hosts ; then
    cat     \$GTFCKNOWNHOSTS \${HOME}/.ssh/known_hosts | sort -u >\${HOME}/.tmpk
    cp \${HOME}/.tmpk \${HOME}/.ssh/known_hosts
  fi
}
setupauthkeys2
for i in \$(/usr/local/bin/git remote); do
  if echo \$i | grep push >/dev/null 2>&1 ; then
    /usr/local/bin/git push -q           \$i master
  else
    /usr/local/bin/git pull -q --ff-only \$i master
  fi
done
setupauthkeys2
if [   -e .gtfc/crontab.pullall.\$(hostname) ]; then
  crontab .gtfc/crontab.pullall.\$(hostname)
else
  crontab .gtfc/crontab.pullall
fi
EOF
  cat >.gtfc/crontab.pullbare <<EOF
* * * * * sh ${FOLDER}/.gtfc/gitpullbare.sh
EOF
  cat >.gtfc/gitpullbare.sh <<EOF
#!/bin/sh
if [ "\$1" != "-f" ]; then
  pgrep -lf gitpullbare.sh >/dev/null 2>&1 && exit 1
fi
cd ${FOLDER}
setupauthkeys2() {
       GTFCAUTHKEYS=.gtfc/authorized_keys2
  [              -e .gtfc/authorized_keys2.\$(hostname) ] \
    && GTFCAUTHKEYS=.gtfc/authorized_keys2.\$(hostname)
  if ! diff \$GTFCAUTHKEYS \${HOME}/.ssh/authorized_keys2 ; then
    echo "command=\"git-shell -c \\\\\"\\\$SSH_ORIGINAL_COMMAND\\\\\"\" \`cat \${HOME}/.ssh/id_rsa.pub\`" >\${HOME}/.tmpa
    cat     \$GTFCAUTHKEYS \${HOME}/.tmpa | sort -u >\${HOME}/.ssh/authorized_keys2
  fi

       GTFCKNOWNHOSTS=.gtfc/known_hosts
  [                -e .gtfc/known_hosts.\$(hostname) ] \
    && GTFCKNOWNHOSTS=.gtfc/known_hosts.\$(hostname)
  if ! diff \$GTFCKNOWNHOSTS \${HOME}/.ssh/known_hosts ; then
    cat     \$GTFCKNOWNHOSTS \${HOME}/.ssh/known_hosts | sort -u >\${HOME}/.tmpk
    cp \${HOME}/.tmpk \${HOME}/.ssh/known_hosts
  fi
}
setupauthkeys2
/usr/local/bin/git pull -q --ff-only
setupauthkeys2
if [   -e .gtfc/crontab.pullbare.\$(hostname) ]; then
  crontab .gtfc/crontab.pullbare.\$(hostname)
else
  crontab .gtfc/crontab.pullbare
fi
EOF
  sh .gtfc/gitpullall.sh
  cp ${HOME}/.ssh/known_hosts .gtfc/known_hosts
  git add .
  git commit -m "added ${HOST} to config, ${MYHOSTNAME} to authorized_keys2, known_hosts"
  # end of init

######################################################################
# This can be skipped if you ssh -A ${MYUSER}@hostB gtfc clone HOSTA
# 2. on HOSTA as ${MYUSER}, run: gtfc add hostB
######################################################################
elif [ "add" = "$1" ]; then # run this on HOSTA before running on clones
  [ -d ${FOLDER} ] || exit 1
  cd ${FOLDER}
  git remote add ${HOST} ssh://${MYUSER}@${HOST}:${PEERPORT}/${FOLDER}
  while diff .git/config .gtfc/config ; do
    sleep 1
  done
  cp .git/config .gtfc/config
  git add .
  git commit -m "added ${HOST} to config"
  # end of add


fi
